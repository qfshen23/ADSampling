import matplotlib.pyplot as plt

# 每个列表长度应为 100（表示 100 个查询，每个查询命中 entry-GT 的 bucket 数）
bucket_hits_k64  = [6708, 6390, 6391, 6310, 6232, 6164, 6214, 6181, 6065, 6075, 6030, 5996, 6045, 5985, 5948, 5964, 5900, 5957, 5909, 5921, 5847, 5921, 5846, 5841, 5822, 5805, 5710, 5840, 5776, 5752, 5738, 5853, 5752, 5864, 5751, 5786, 5766, 5772, 5794, 5750, 5724, 5689, 5769, 5703, 5713, 5680, 5682, 5658, 5631, 5628, 5658, 5710, 5584, 5664, 5647, 5643, 5589, 5657, 5609, 5569, 5593, 5641, 5543, 5657, 5604, 5576, 5503, 5561, 5541, 5609, 5506, 5564, 5576, 5466, 5547, 5561, 5542, 5615, 5474, 5516, 5529, 5544, 5407, 5574, 5517, 5555, 5484, 5468, 5469, 5414, 5473, 5502, 5502, 5423, 5452, 5486, 5513, 5493, 5471, 5423]
bucket_hits_k256  = [5337, 5063, 4875, 4878, 4846, 4801, 4751, 4665, 4602, 4546, 4621, 4552, 4510, 4509, 4463, 4465, 4409, 4336, 4397, 4361, 4396, 4394, 4380, 4387, 4320, 4324, 4306, 4262, 4318, 4243, 4295, 4288, 4316, 4186, 4155, 4234, 4276, 4201, 4122, 4163, 4195, 4182, 4154, 4094, 4154, 4093, 4117, 4089, 4143, 4025, 4086, 4018, 4113, 4083, 4000, 4055, 4036, 4053, 3964, 4003, 4025, 3997, 4028, 4114, 4041, 3937, 3935, 3976, 3972, 3946, 3943, 4005, 3989, 3962, 3930, 3879, 3945, 3855, 3927, 3903, 3950, 3856, 3900, 3778, 3929, 3927, 3803, 3827, 3872, 3925, 3851, 3841, 3813, 3864, 3804, 3914, 3838, 3808, 3789, 3754]
bucket_hits_k512 = [4797, 4542, 4368, 4312, 4164, 4162, 4051, 4033, 4068, 4012, 3972, 3952, 3794, 3915, 3836, 3790, 3807, 3818, 3750, 3810, 3664, 3750, 3776, 3674, 3709, 3612, 3736, 3713, 3660, 3641, 3600, 3657, 3550, 3544, 3524, 3552, 3572, 3526, 3520, 3471, 3563, 3469, 3460, 3495, 3477, 3411, 3421, 3358, 3396, 3457, 3474, 3485, 3413, 3365, 3323, 3346, 3387, 3372, 3401, 3341, 3315, 3351, 3305, 3351, 3236, 3302, 3235, 3233, 3333, 3365, 3297, 3252, 3367, 3211, 3334, 3270, 3233, 3254, 3264, 3128, 3294, 3272, 3185, 3195, 3141, 3240, 3185, 3171, 3187, 3182, 3200, 3137, 3148, 3208, 3135, 3143, 3108, 3112, 3178, 3122]
bucket_hits_k1024  = [4233, 4005, 3908, 3716, 3711, 3564, 3572, 3418, 3454, 3454, 3321, 3352, 3334, 3332, 3250, 3241, 3208, 3230, 3141, 3254, 3240, 3230, 3172, 3091, 3148, 3118, 3013, 3071, 3007, 2964, 2941, 3072, 2956, 2928, 2964, 2925, 2975, 2946, 2900, 2862, 2931, 2888, 2906, 2833, 2871, 2869, 2885, 2785, 2825, 2824, 2820, 2867, 2838, 2767, 2844, 2703, 2767, 2764, 2733, 2665, 2715, 2749, 2655, 2784, 2655, 2627, 2672, 2648, 2703, 2739, 2703, 2670, 2679, 2629, 2666, 2558, 2603, 2633, 2686, 2597, 2636, 2599, 2632, 2575, 2607, 2552, 2572, 2622, 2625, 2548, 2608, 2613, 2627, 2507, 2504, 2554, 2484, 2561, 2542, 2456]

# 放在 dict 方便循环处理
all_data = {
    "K=64": bucket_hits_k64,
    "K=256": bucket_hits_k256,
    "K=512": bucket_hits_k512,
    "K=1024": bucket_hits_k1024,
}

# Calculate average values for each dataset
averages = {}
for title, values in all_data.items():
    averages[title] = sum(values) / len(values)
    print(f"Average for {title}: {averages[title]:.2f}")

# 绘图
fig, axes = plt.subplots(2, 2, figsize=(16, 10))
axes = axes.flatten()

for idx, (title, values) in enumerate(all_data.items()):
    ax = axes[idx]
    ax.bar(range(1, len(values)+1), values, color='skyblue')
    ax.set_title(f"Query-GT kNN Bucket Count, {title}", fontsize=13)
    ax.set_xlabel("Query Index (1 to 100)")
    ax.set_ylabel("Hit Count")
    ax.grid(True)
    
    # Add average line and text
    avg = averages[title]
    ax.axhline(y=avg, color='red', linestyle='--', linewidth=1.5)
    ax.text(len(values)*0.75, avg*1.05, f'Avg: {avg:.2f}', 
            color='red', fontweight='bold')

plt.tight_layout()
plt.suptitle("Bucket Count per Query for GT kNN across Cluster Sizes", fontsize=16, y=1.03)
plt.savefig("Distribution_query_gt_kNN.png", dpi=600)
